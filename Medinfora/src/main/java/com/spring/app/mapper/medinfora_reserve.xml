<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.app.reserve.model.ReserveDAO">
	
	<!-- (진료예약)회원가입된 병원 개수  -->
	<select id="getTotalCnt" resultType="int" parameterType="HashMap">
		SELECT count(*) 
		FROM
		(
		    select hidx
		    from member
		    where midx = 2
		) M
		JOIN
		(
		    SELECT hidx, hpname, hpaddr, hptel, H.classcode
		    FROM
		    (
		        select hidx, hpname, hpaddr, hptel, classcode
		        from hospital
		        where 1=1
		       <choose>
					<when test='city != "" '>
				    	and hpaddr like '%' || #{city} || '%'
				    </when>
				    <when test='local != "" '>
				    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
				    </when>
				    <when test='hpname != "" '>
				    	and hpname like '%' || #{hpname} || '%'
				    </when>
				    <when test='classcode != "" '>
				    	and classcode = #{classcode}
				    </when>
			    </choose>
		    ) H
		    JOIN
		    (
		        select classcode, classname
		        from classcode
		    ) C
		    ON H.classcode = C.classcode
		) HC
		ON M.hidx = HC.hidx
	</select>
	
	<!-- (진료예약)회원가입된 병원 리스트 가져오기  -->
	<select id="mbHospitalList" resultType="HospitalDTO" parameterType="HashMap">
		SELECT hidx, hpname, hpaddr, hptel, classcode
		FROM
		(
		    SELECT row_number() over(order by HC.hidx desc) AS rno
		        , HC.hidx as hidx, hpname, hpaddr, hptel, classcode
		    FROM
		    (
		        select hidx
		        from member
		        where midx = 2
		    ) M
		    JOIN
		    (
		        SELECT hidx, hpname, hpaddr, hptel, H.classcode
		        FROM
		        (
		            select hidx, hpname, hpaddr, hptel, classcode
		            from hospital
		            where 1=1
		            <choose>
						<when test='city != "" '>
					    	and hpaddr like '%' || #{city} || '%'
					    </when>
					    <when test='local != "" '>
					    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
					    </when>
					    <when test='hpname != "" '>
					    	and hpname like '%' || #{hpname} || '%'
					    </when>
					    <when test='classcode != "" '>
					    	and classcode = #{classcode}
					    </when>
				    </choose>
		        ) H
		        JOIN
		        (
		            select classcode, classname
		            from classcode
		        ) C
		        ON H.classcode = C.classcode
		    ) HC
		    ON M.hidx = HC.hidx
		    order by hidx
		)
		WHERE rno BETWEEN #{startRno} AND #{endRno}
	</select>
	
</mapper>