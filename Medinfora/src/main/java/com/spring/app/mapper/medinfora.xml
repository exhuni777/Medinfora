<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mediinfora">
	
	<!-- 로그인 유저 정보 가져오기 -->
	<select id="getLoginuser" parameterType="HashMap" resultType="MemberDTO">
		SELECT userid, email, name, address, detailAddress, birthday, mobile, gender, M.registerday, midx, hidx,
		       , pwdUpdategap
		       , NVL(lastlogingap, trunc( months_between(sysdate, M.registerday) )) AS lastlogingap
		FROM
		(
		    select userid, email, name, address, detailAddress, birthday, mobile, gender, registerday, midx, hidx
		           , trunc( months_between(sysdate, pwdupdateday) ) as pwdUpdategap
		    from member
		    where (midx between 0 and 8)
		    <choose>
		    	<when test="loginmethod =='0'">	<!-- 일반로그인 -->
		    		and userid = #{userid} and pwd = #{pwd}
		    	</when>
		    	<when test="loginmethod =='1'"> <!-- 카카오 로그인  -->
		    		and userid = #{userid}
		    	</when>
		    </choose>
		)M
		CROSS JOIN
		(
		    select trunc( months_between(sysdate, max(registerday)) ) as lastlogingap
		    from loginlog
		    where userid = #{userid}
		) L
	</select>
	
	<!-- 회원코드 변경 (휴먼처리) -->
	<update id="updatemIdx" parameterType="HashMap">
		update member set mIdx = to_number(#{idx})
		where userid = #{userid}
	</update>
	
	<!-- 로그인 유저 ip 기록 -->
	<insert id="insert_log" parameterType="HashMap">
		insert into loginlog(userid, ip, registerday)
		values(#{userid}, #{clientip}, sysdate)
	</insert>
	
	<!-- 병원정보 입력 API -->
	<insert id="hpApiInputer" parameterType="HospitalDTO">
		INSERT INTO HOSPITAL (HIDX, HPNAME, HPADDR, HPTEL, CLASSCODE, AGENCY, WGS84LON, WGS84LAT,
		STARTTIME1, STARTTIME2, STARTTIME3, STARTTIME4, STARTTIME5, STARTTIME6, STARTTIME7, STARTTIME8,
        ENDTIME1, ENDTIME2, ENDTIME3, ENDTIME4, ENDTIME5, ENDTIME6, ENDTIME7, ENDTIME8)
		VALUES (seq_hidx.nextval, #{hpname}, #{hpaddr}, #{hptel}, #{classcode}, #{agency}, #{wgs84lon}, #{wgs84lat}, 
		#{starttime1}, #{starttime2}, #{starttime3}, #{starttime4}, #{starttime5}, #{starttime6}, #{starttime7}, #{starttime8},
		#{endtime1}, #{endtime2}, #{endtime3}, #{endtime4}, #{endtime5}, #{endtime6}, #{endtime7}, #{endtime8})
	</insert>
	
<!-- 	
	<select id="getTotalCount" parameterType="HashMap" resultType="int">
	    select count(*)
   		 from notice
    
	</select> -->
	
		
	<insert id="noticeWrite" parameterType="NoticeDTO">
		insert into notice (nidx, userid, title, content, viewcnt, writeday)
        values (seq_notice.nextval, #{userid}, #{title}, #{content}, #{viewcnt}, #{writeday})
    </insert>
    
	 <select id="boardListNoSearch" resultType="NoticeDTO">
		select nidx, userid, title, content, viewcnt, TO_CHAR(TO_DATE(writeday, 'yyyy-mm-dd hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') AS writeday, filename, orgname, filesize
		from notice
		order by nidx desc;
    </select>
    
   <!--  <select id="noticeListSearch_withPaging" parameterType="HashMap" resultType="NoticeDTO">
	 SELECT nidx, userid, title, content, viewcnt, TO_CHAR(TO_DATE(writeday, 'yyyy-mm-dd hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') AS writeday, filename, orgname, filesize
		FROM
		(
		 select row_number() over(order by nidx desc) AS rno 
		      , nidx, userid, content, title
		      , viewcnt, TO_CHAR(TO_DATE(writeday, 'yyyy-mm-dd hh24:mi:ss')) AS writeday 
		     ,filename, orgname, filesize
		 from notice
	) V
	
		WHERE rno between #{startRno} and #{endRno}
	</select>
     -->
	  <!-- 총 게시물 건수(totalCount) 구하기 - 검색이 있을 때와 검색이 없을 때로 나뉜다 -->
<!--     <select id="getTotalCount" parameterType="HashMap" resultType="int">
        SELECT COUNT(*)
        FROM notice
        WHERE 1=1
        <if test="searchType != null and searchType != ''">
            AND ${searchType} LIKE '%' || #{searchWord} || '%'
        </if>
    </select>

    글목록 가져오기(페이징 처리 했으며, 검색어가 있는 것 또는 검색어 없는 것 모두 포함한 것
    <select id="noticeListSearch_withPaging" parameterType="HashMap" resultType="NoticeDTO">
        SELECT nidx, userid, title, content, viewcnt, 
               TO_CHAR(TO_DATE(writeday, 'YYYYMMDD'), 'yyyy-mm-dd') AS writeday,
               filename, orgname, filesize
        FROM (
            SELECT rownum AS rno, nidx, userid, title, content, viewcnt, writeday, filename, orgname, filesize
            FROM notice
            WHERE 1=1
            <if test="searchType != null and searchType != ''">
                AND ${searchType} LIKE '%' || #{searchWord} || '%'
            </if>
            ORDER BY nidx DESC
        )
        WHERE rno BETWEEN #{startRno} AND #{endRno}
    </select> -->
    <!-- 총 게시물 건수(totalCount) 구하기 - 검색이 있을 때와 검색이 없을 때로 나뉜다 -->
    <select id="getTotalCount" parameterType="HashMap" resultType="int">
        SELECT COUNT(*)
        FROM notice
        WHERE 1=1
        <if test="searchType != null and searchType != ''">
            AND ${searchType} LIKE '%' || #{searchWord} || '%'
        </if>
    </select>

    <!-- 글목록 가져오기(페이징 처리 했으며, 검색어가 있는 것 또는 검색어 없는 것 모두 포함한 것 -->
    <select id="noticeListSearch_withPaging" parameterType="HashMap" resultType="NoticeDTO">
        SELECT nidx, userid, title, content, viewcnt, 
               TO_CHAR(TO_DATE(writeday, 'YYYYMMDD'), 'yyyy-mm-dd') AS writeday,
               filename, orgname, filesize
        FROM (
            SELECT rownum AS rno, nidx, userid, title, content, viewcnt, writeday, filename, orgname, filesize
            FROM notice
            WHERE 1=1
            <if test="searchType != null and searchType != ''">
                AND ${searchType} LIKE '%' || #{searchWord} || '%'
            </if>
            ORDER BY nidx DESC
        )
        WHERE rno BETWEEN #{startRno} AND #{endRno}
    </select>

	
</mapper>