<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.app.reserve.model.ReserveDAO">
	
	<!-- (진료예약-병원선택)회원가입된 병원 개수  -->
	<select id="getTotalCnt" resultType="int" parameterType="HashMap">
		SELECT count(*) 
		FROM
		(
		    select hidx
		    from member
		    where midx = 2
		) M
		JOIN
		(
		    SELECT hidx, hpname, hpaddr, hptel, H.classcode
		    FROM
		    (
		        select hidx, hpname, hpaddr, hptel, classcode
		        from hospital
		        where 1=1
		       <choose>
					<when test='city != "" '>
				    	and hpaddr like '%' || #{city} || '%'
				    </when>
				    <when test='local != "" '>
				    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
				    </when>
				    <when test='hpname != "" '>
				    	and hpname like '%' || #{hpname} || '%'
				    </when>
				    <when test='classcode != "" '>
				    	and classcode = #{classcode}
				    </when>
			    </choose>
		    ) H
		    JOIN
		    (
		        select classcode, classname
		        from classcode
		    ) C
		    ON H.classcode = C.classcode
		) HC
		ON M.hidx = HC.hidx
	</select>
	
	<!-- (진료예약-병원선택)회원가입된 병원 리스트 가져오기  -->
	<select id="mbHospitalList" resultType="HospitalDTO" parameterType="HashMap">
		SELECT hidx, hpname, hpaddr, hptel, classcode
		FROM
		(
		    SELECT row_number() over(order by HC.hidx desc) AS rno
		        , HC.hidx as hidx, hpname, hpaddr, hptel, classcode
		    FROM
		    (
		        select hidx
		        from member
		        where midx = 2
		    ) M
		    JOIN
		    (
		        SELECT hidx, hpname, hpaddr, hptel, H.classcode
		        FROM
		        (
		            select hidx, hpname, hpaddr, hptel, classcode
		            from hospital
		            where 1=1
		           	<if test='city != "" '>
				    	and hpaddr like '%' || #{city} || '%'
				    </if>
				    <if test='local != "" '>
				    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
				    </if>
				    <if test='hpname != "" '>
				    	and hpname like '%' || #{hpname} || '%'
				    </if>
				    <if test='classcode != "" '>
				    	and classcode = #{classcode}
				    </if>
		        ) H
		        JOIN
		        (
		            select classcode, classname
		            from classcode
		        ) C
		        ON H.classcode = C.classcode
		    ) HC
		    ON M.hidx = HC.hidx
		    order by hidx
		)
		WHERE rno BETWEEN #{startRno} AND #{endRno}
	</select>

	<!-- 날짜가 공휴일인지 체크 -->
	<select id="holidayCheck" resultType="int" parameterType="String">
		select count(*)
		from holiday
		where holiday_date = #{day}
	</select>
	
	<!-- 병원의 오픈시간과 마감시간 파악  -->
	<select id="hospitalTime" resultType="HospitalDTO" parameterType="String">
		select hidx
	        , nvl(starttime1, ' ') as starttime1, nvl(starttime2, ' ') as starttime2, nvl(starttime3, ' ') as starttime3
	        , nvl(starttime4, ' ') as starttime4, nvl(starttime5, ' ') as starttime5, nvl(starttime6, ' ') as starttime6
	        , nvl(starttime7, ' ') as starttime7, nvl(starttime8,' ') as starttime8
	        , nvl(endtime1, ' ') as endtime1, nvl(endtime2, ' ') as endtime2, nvl(endtime3, ' ') as endtime3
	        , nvl(endtime4, ' ') as endtime4, nvl(endtime5, ' ') as endtime5, nvl(endtime6, ' ') as endtime6
	        , nvl(endtime7, ' ') as endtime7, nvl(endtime8, ' ') as endtime8
		from hospital
		where hidx = #{hidx}
	</select>
	
	<!-- 선택한 날의 예약 개수 파악  -->
	<select id="reserveCnt" resultType="int" parameterType="HashMap">
		select count(*)
		from reserve
		where to_date(checkin,'yyyy-mm-dd hh24:mi:ss') > to_char(to_date(#{day},'yyyy-mm-dd hh24:mi:ss'))
			and hidx = #{hidx}
	</select>
	
	<!-- 현재시간 이후, 선택한 날짜와 예약일이 같은 경우  -->
	<select id="dayReserveImpossible" resultType="HospitalDTO" parameterType="HashMap">
		select ridx, userid, reportday, checkin, symptom, rcode, hidx
		from reserve
		where hidx = #{hidx}
			and to_date(checkin,'yyyy-mm-dd hh24:mi:ss') > to_char(to_date(sysdate,'yyyy-mm-dd hh24:mi:ss'))
		    or checkin = #{day}
	</select>
</mapper>