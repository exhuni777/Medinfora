<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.app.reserve.model.ReserveDAO">
	
	<!-- (진료예약-병원선택)회원가입된 병원 개수  -->
	<select id="getTotalCnt" resultType="int" parameterType="HashMap">
		SELECT count(*) 
		FROM
		(
		    select hidx
		    from member
		    where midx = 2
		) M
		JOIN
		(
		    SELECT hidx, hpname, hpaddr, hptel, H.classcode
		    FROM
		    (
		        select hidx, hpname, hpaddr, hptel, classcode
		        from hospital
		        where 1=1
		       <choose>
					<when test='city != "" '>
				    	and hpaddr like '%' || #{city} || '%'
				    </when>
				    <when test='local != "" '>
				    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
				    </when>
				    <when test='hpname != "" '>
				    	and hpname like '%' || #{hpname} || '%'
				    </when>
				    <when test='classcode != "" '>
				    	and classcode = #{classcode}
				    </when>
			    </choose>
		    ) H
		    JOIN
		    (
		        select classcode, classname
		        from classcode
		    ) C
		    ON H.classcode = C.classcode
		) HC
		ON M.hidx = HC.hidx
	</select>
	
	<!-- (진료예약-병원선택)회원가입된 병원 리스트 가져오기  -->
	<select id="mbHospitalList" resultType="HospitalDTO" parameterType="HashMap">
		SELECT hidx, hpname, hpaddr, hptel, classcode
		FROM
		(
		    SELECT row_number() over(order by HC.hidx desc) AS rno
		        , HC.hidx as hidx, hpname, hpaddr, hptel, classcode
		    FROM
		    (
		        select hidx
		        from member
		        where midx = 2
		    ) M
		    JOIN
		    (
		        SELECT hidx, hpname, hpaddr, hptel, H.classcode
		        FROM
		        (
		            select hidx, hpname, hpaddr, hptel, classcode
		            from hospital
		            where 1=1
		           	<if test='city != "" '>
				    	and hpaddr like '%' || #{city} || '%'
				    </if>
				    <if test='local != "" '>
				    	and hpaddr like '%' || #{city} || '%' || #{local} || '%'
				    </if>
				    <if test='hpname != "" '>
				    	and hpname like '%' || #{hpname} || '%'
				    </if>
				    <if test='classcode != "" '>
				    	and classcode = #{classcode}
				    </if>
		        ) H
		        JOIN
		        (
		            select classcode, classname
		            from classcode
		        ) C
		        ON H.classcode = C.classcode
		    ) HC
		    ON M.hidx = HC.hidx
		    order by hidx
		)
		WHERE rno BETWEEN #{startRno} AND #{endRno}
	</select>

	<!-- 날짜가 공휴일인지 체크 -->
	<select id="holidayCheck" resultType="int" parameterType="String">
		select count(*)
		from holiday
		where holiday_date = #{day}
	</select>
	
	<!-- 병원과 요일 파악하여, 오늘(현재시간 이후) 진료예약 가능한 업무시간 파악하기  -->
	<select id="todayReserveAvailable" resultType="HospitalDTO">
		select *
		from holiday
	</select>
</mapper>